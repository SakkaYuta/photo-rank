# 要件定義書 v4.0 – オンラインデータ選択 → グッズ化フロー（改訂）

本ドキュメントは v3.1（クリエイターのデザインアップロード/販売を前提）から、
「ユーザーがグッズにしたいオンラインデータを選んで、グッズ化する」フローへ要件を置き換えた改訂版です。
v3.1は履歴のため残し、v4.0を以降の実装基準とします。

## ビジョン / スコープ

- ビジョン: 誰でも、オンライン上の許諾可能なデータを選んで、数クリックで高品質なグッズ化/購入ができる。
- スコープ（本改訂での明確化）:
  - オンラインデータの「購入/ダウンロード販売」は行わない（デジタル販売は非対象）。
  - ユーザーはオンラインデータのURL等を指定/検索して選択し、それを元に物理グッズを作成・購入する。
  - 著作権/利用許諾の方針に従い、許される範囲のみでグッズ化を実施。

## ペルソナ / ロール

1) 購入者（エンドユーザー）
- オンラインデータ（画像/投稿など）のURLを入力/検索で選ぶ
- プレビュー（透かし）を確認し、グッズ種類・オプションを選択
- 規約/許諾条件に同意のうえ決済 → 発送トラッキング確認

2) 版権管理者（オーガナイザー/権利者）
- 許容ドメイン/プロバイダの方針管理（ホワイト/ブラックリスト）
- 個別アセットの承認/却下（必要な場合）
- 申請/異議（削除依頼、DMCA 相当）への対応

3) 管理者（プラットフォーム運営）
- 全体設定（ポリシー、レート制限、監査）
- 製造パートナー/決済/通知の健全性監視

4) 製造パートナー（システム連携）
- 受注データをAPIで受け取り、製造/発送を実施

（注）v3.1の「クリエイター」ロールによるアップロード/販売は、本改訂フローでは必須ではありません。

## ユーザージャーニー（新フロー）

1) データ選択
- ユーザーが URL を入力、または対応プロバイダ（例: SNS/画像サービス）の検索/貼付
- システムがメタデータ（タイトル/作者名/サムネ等）を取得し、利用可否ポリシーを評価
- 利用可（Auto）: 次のステップへ。条件付き/不明（Manual）: 版権管理者の承認待ちへ。

2) プレビュー/編集
- 透かし付きプレビュー（軽微なトリミング/位置調整など）
- グッズ種別・サイズ・色・数量を選択

3) 注文/決済
- 規約/許諾条件への同意（対象データの利用保証/責任範囲の明記）
- 決済（Stripe）完了後、製造発注を作成

4) 製造/配送
- 製造パートナーAPIへ発注、進捗・追跡番号の連携
- ユーザーは注文履歴から配送状況を確認

5) 権利保護/コンプライアンス
- 方針外のデータはブロック（ドメイン/署名/メタデータ判定）
- 承認待ち/却下/削除要請のワークフロー
- ログ/監査（誰が何を、いつ、どう使ったか）

## 機能要件

1) オンラインデータ取り込み（Ingestion）
- URL受付、対応プロバイダ判定、メタデータ取得（oEmbed/API/スクレイプ方針）
- コンテンツハッシュ/署名による同一性判定、重複抑止
- ドメイン/プロバイダごとの利用方針（Allow/Deny/Manual）

2) 権利管理/承認フロー
- 手動承認が必要なアセットのキューイング/レビュー/記録
- ログ/監査証跡（承認者、理由、時刻）
- 取り下げ（Takedown）受付と実行履歴

3) プレビュー/変換
- 透かし/縮小等の安全なプレビュー生成（原画像は非公開）
- 画像領域の簡易編集（トリミング/位置調整/背景色）

4) グッズ構成/カタログ
- 商品種別・バリエーション・価格ルール（原価+プラットフォームマークアップ）
- アセットとグッズ構成の紐付け（印刷領域のレイアウト設定）

5) 注文/決済/在庫ロック
- 決済前ロック（同一アセット/在庫の重複競合対策）
- Stripe 決済、Webhook による確定/失敗/返金ハンドリング
- 製造発注の作成/更新、追跡番号の取得

6) 通知/外部連携
- 製造パートナーへのWebhook/REST連携
- 失敗時のリトライ/再通知キュー

7) セキュリティ/コンプライアンス
- RLS/ポリシー（ユーザー自身のアセット/注文のみアクセス可）
- ストレージの原画像/プレビュー分離（非公開/公開）
- レート制限、監査ログ、データ保持方針

## 非機能要件

- 性能: プレビュー生成 < 3s（90パーセンタイル）、決済〜発注作成 < 5s 目標
- 可用性: 主要API 99.9%/月、Webhook リトライで整合性担保
- 監査/ログ: 行為ログ、承認ログ、外部連携ログを90日以上保管
- セキュリティ: OWASP ASVS 準拠、PII/決済情報の適切な隔離

## データモデル（概念）

- online_assets: 取得したオンラインデータの記録（source_url, provider, author, title, content_hash, policy, status, fetched_at など）
- asset_policies: ドメイン/プロバイダ/パターンごとの方針（allow/deny/manual, 例外ルール）
- asset_approvals: 手動承認の記録（asset_id, reviewer_id, decision, reason, timestamps）
- goods_configurations: アセット×商品種別×レイアウト/オプション
- orders: 顧客注文（支払、配送、合計、状態）
- manufacturing_orders: 製造発注（パートナー、状態、追跡番号）
- notifications/queues: 外部通知のキュー/履歴

（実装メモ）既存スキーマを活用する場合：
- `works` は「アセット×グッズ構成」の一時的/再利用可能なエンティティとして再解釈可能
- `purchases` は注文明細として継続利用可能
- 追加で `online_assets`/`asset_policies`/`asset_approvals` を新設

## API/エッジ関数（概要）

- ingest-online-asset: URL検証→メタデータ取得→`online_assets` 作成→ポリシー判定（Auto/Manual）
- generate-preview: 非公開取得→透かし/編集→公開プレビュー保存
- create-payment-intent / stripe-webhook: 既存の決済/ロック/確定ロジックを継続活用
- manufacturing-order / notify-partner / process-notification-queue: 既存の製造/通知連携を継続活用

## RLS/ストレージ方針（概念）

- online_assets: `owner_user_id = auth.uid()` のみ参照/編集（共有/公開はしない）
- ストレージ: `photos-original`（非公開）/`photos-watermarked`（公開）等の分離、フォルダ命名に `user_id` を含める
- orders/purchases: 自分の注文のみ参照/編集（管理者/権利者は必要最低限の範囲）

## 料金/収益モデル（改訂）

- 本改訂では「オンラインデータのデジタル販売」を行わない
- 収益は「商品価格 = 原価 + プラットフォームマークアップ」で構成
- 権利者へのロイヤリティが必要なケースは将来要件（本版では範囲外）

## 実装計画（フェーズ）

Phase 1: 基本フロー（2週間）
- ingest-online-asset（URL入力→メタ取得→ポリシー評価）
- generate-preview（透かし/編集）
- 商品カタログ/構成選択→決済→発注

Phase 2: 権利/ポリシー（1週間）
- ドメイン/プロバイダ方針管理、承認キュー/審査UI
- 取り下げ要請/ログ/監査

Phase 3: 運用/安定化（1週間）
- メトリクス/ダッシュボード/失敗時再送
- レート制限/アラート/バックフィル

## 互換性/移行

- v3.1 の「クリエイターアップロード→出品→承認→販売」フローは段階的に停止可能
- 既存テーブルの再解釈/拡張により、段階移行を支援（`works`/`purchases` 再利用）
- 新規テーブル（`online_assets` 等）は既存のRLS/監査パターンに合わせて追加

---
本ドキュメントは、要件の方向性を確定するための実装非依存の定義です。詳細スキーマ/ポリシー/API仕様は設計ドキュメントで別途確定します。

