import React, { useMemo, useState } from 'react'
import { Card } from '../../components/ui/card'
import { Button } from '../../components/ui/button'
import { Badge } from '../../components/ui/badge'
import { Star, Clock, Package, TrendingUp, AlertCircle, CheckCircle, Truck, Award } from 'lucide-react'
import { TrustBadges } from '@/components/common/TrustBadges'

type Factory = {
  id: number
  name: string
  logo: string
  price: number
  leadTime: number
  rating: number
  completedOrders: number
  location: string
  features: string[]
  printMethod: string
  minLot: number
  score: number
  reviews: number
  onTimeRate: number
  defectRate: number
  specialOffer: string | null
}

export const FactoryCompare: React.FC = () => {
  const [selectedFactoryId, setSelectedFactoryId] = useState<number | null>(null)
  const [sortBy, setSortBy] = useState<'score' | 'price' | 'leadTime' | 'rating'>('score')

  const product = {
    type: 'T„Ç∑„É£„ÉÑ',
    quantity: 50,
    designUrl: '/sample-design.jpg',
    requiredDate: '2024-11-01',
  }

  const factories: Factory[] = [
    {
      id: 1,
      name: '„Çπ„Éî„Éº„Éâ„Éó„É™„É≥„ÉàÊù±‰∫¨',
      logo: 'üè≠',
      price: 1200,
      leadTime: 3,
      rating: 4.8,
      completedOrders: 1250,
      location: 'Êù±‰∫¨ÈÉΩ',
      features: ['Âç≥Êó•Áô∫ÈÄÅÂèØ', '„Çµ„É≥„Éó„É´ÁÑ°Êñô'],
      printMethod: 'DTG„Éó„É™„É≥„Éà',
      minLot: 1,
      score: 95,
      reviews: 234,
      onTimeRate: 98,
      defectRate: 0.5,
      specialOffer: 'ÂàùÂõû10%OFF',
    },
    {
      id: 2,
      name: 'Èñ¢Ë•ø„Éó„É™„É≥„ÉàÂ∑•Êàø',
      logo: 'üè¢',
      price: 980,
      leadTime: 5,
      rating: 4.5,
      completedOrders: 890,
      location: 'Â§ßÈò™Â∫ú',
      features: ['Â§ßÂè£Ââ≤Âºï', 'È´òÂìÅË≥™‰øùË®º'],
      printMethod: '„Ç∑„É´„ÇØ„Çπ„ÇØ„É™„Éº„É≥',
      minLot: 10,
      score: 88,
      reviews: 156,
      onTimeRate: 95,
      defectRate: 1.2,
      specialOffer: null,
    },
    {
      id: 3,
      name: '„Ç®„Ç≥„Éó„É™„É≥„Éà‰πùÂ∑û',
      logo: 'üå±',
      price: 1100,
      leadTime: 7,
      rating: 4.6,
      completedOrders: 567,
      location: 'Á¶èÂ≤°Áúå',
      features: ['Áí∞Â¢ÉÈÖçÊÖÆ', '„Ç™„Éº„Ç¨„Éã„ÉÉ„ÇØÁ¥†Êùê'],
      printMethod: 'Ê∞¥ÊÄß„Ç§„É≥„ÇØ„Ç∏„Çß„ÉÉ„Éà',
      minLot: 20,
      score: 82,
      reviews: 89,
      onTimeRate: 96,
      defectRate: 0.8,
      specialOffer: 'ÈÄÅÊñôÁÑ°Êñô',
    },
  ]

  const sortedFactories = useMemo(() => {
    return [...factories].sort((a, b) => {
      switch (sortBy) {
        case 'price':
          return a.price - b.price;
        case 'leadTime':
          return a.leadTime - b.leadTime;
        case 'rating':
          return b.rating - a.rating;
        case 'score':
          return b.score - a.score;
        default:
          return b.score - a.score;
      }
    })
  }, [sortBy])

  const getScoreBreakdown = (factory: Factory) => ({
    price: factory.price <= 1000 ? 100 : Math.max(0, 100 - (factory.price - 1000) / 10),
    speed: Math.max(0, 100 - factory.leadTime * 10),
    quality: Math.min(100, factory.rating * 20),
    reliability: factory.onTimeRate,
  })

  const getRecommendationReason = (factory: Factory) => {
    const reasons: string[] = []
    if (factory.price === Math.min(...factories.map((f) => f.price))) reasons.push('ÊúÄÂÆâÂÄ§')
    if (factory.leadTime === Math.min(...factories.map((f) => f.leadTime))) reasons.push('ÊúÄÈÄüÁ¥çÊúü')
    if (factory.rating === Math.max(...factories.map((f) => f.rating))) reasons.push('ÊúÄÈ´òË©ï‰æ°')
    if (factory.score === Math.max(...factories.map((f) => f.score))) reasons.push('Á∑èÂêà1‰Ωç')
    return reasons
  }

  return (
    <div className="max-w-7xl mx-auto p-6 space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Ë£ΩÈÄ†„Éë„Éº„Éà„Éä„Éº„ÇíÈÅ∏Êäû</h2>
          <p className="text-gray-600 mt-1">
            {product.type} √ó {product.quantity}Êûö„ÅÆË¶ãÁ©ç„ÇÇ„ÇäÊØîËºÉ
          </p>
        </div>
        <div className="flex gap-2">
          <Button variant={sortBy === 'score' ? 'primary' : 'secondary'} size="sm" onClick={() => setSortBy('score')}>
            „Åä„Åô„Åô„ÇÅÈ†Ü
          </Button>
          <Button variant={sortBy === 'price' ? 'primary' : 'secondary'} size="sm" onClick={() => setSortBy('price')}>
            ‰æ°Ê†ºÈ†Ü
          </Button>
          <Button variant={sortBy === 'leadTime' ? 'primary' : 'secondary'} size="sm" onClick={() => setSortBy('leadTime')}>
            Á¥çÊúüÈ†Ü
          </Button>
          <Button variant={sortBy === 'rating' ? 'primary' : 'secondary'} size="sm" onClick={() => setSortBy('rating')}>
            Ë©ï‰æ°È†Ü
          </Button>
        </div>
      </div>

      <div className="grid gap-4">
        {sortedFactories.map((factory, index) => {
          const isSelected = selectedFactoryId === factory.id
          const reasons = getRecommendationReason(factory)
          const scoreBreakdown = getScoreBreakdown(factory)
          return (
            <Card key={factory.id} className={`relative transition-all cursor-pointer hover:shadow-large ${isSelected ? 'ring-2 ring-primary-500 bg-primary-50/30' : ''}`}>
              {index === 0 && sortBy === 'score' && (
                <div className="absolute -top-3 left-6">
                  <Badge variant="primary" size="lg">
                    <Award className="w-4 h-4 mr-1" />„Åä„Åô„Åô„ÇÅ
                  </Badge>
                </div>
              )}
              {factory.specialOffer && (
                <div className="absolute -top-3 right-6">
                  <Badge variant="warning" size="md">{factory.specialOffer}</Badge>
                </div>
              )}

              <div className="grid md:grid-cols-12 gap-6">
                <div className="md:col-span-3">
                  <div className="flex items-start gap-3">
                    <div className="text-3xl">{factory.logo}</div>
                    <div>
                      <h3 className="font-semibold text-lg jp-text line-clamp-2">{factory.name}</h3>
                      <p className="text-sm text-gray-600 jp-text">{factory.location}</p>
                      <div className="flex items-center gap-1 mt-1">
                        <Star className="w-4 h-4 text-yellow-400 fill-current" />
                        <span className="font-semibold">{factory.rating}</span>
                        <span className="text-sm text-gray-500">({factory.reviews}‰ª∂)</span>
                      </div>
                      <div className="mt-2">
                        <TrustBadges />
                      </div>
                    </div>
                  </div>
                  {reasons.length > 0 && (
                    <div className="flex flex-wrap gap-1 mt-3">
                      {reasons.map((r) => (
                        <Badge key={r} variant="success" size="sm">
                          {r}
                        </Badge>
                      ))}
                    </div>
                  )}
                </div>

                <div className="md:col-span-3">
                  <div className="space-y-3">
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">Âçò‰æ°</span>
                      <span className="text-2xl font-bold text-primary-600">¬•{factory.price.toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">ÂêàË®àÈáëÈ°ç</span>
                      <span className="font-semibold">¬•{(factory.price * product.quantity).toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600"><Clock className="inline w-4 h-4 mr-1" />Á¥çÊúü</span>
                      <span className="font-semibold">{factory.leadTime}Âñ∂Ê•≠Êó•</span>
                    </div>
                  </div>
                </div>

                <div className="md:col-span-3">
                  <div className="space-y-2">
                    <div className="flex items-center gap-2"><Package className="w-4 h-4 text-gray-500" /><span className="text-sm">{factory.printMethod}</span></div>
                    <div className="flex items-center gap-2"><TrendingUp className="w-4 h-4 text-gray-500" /><span className="text-sm">ÊúÄÂ∞è„É≠„ÉÉ„Éà: {factory.minLot}Êûö</span></div>
                    <div className="flex items-center gap-2"><Truck className="w-4 h-4 text-gray-500" /><span className="text-sm">Á¥çÊúüÈÅµÂÆàÁéá: {factory.onTimeRate}%</span></div>
                    <div className="flex flex-wrap gap-1 pt-1">
                      {factory.features.map((f) => (
                        <span key={f} className="text-xs px-2 py-1 bg-gray-100 rounded-md">{f}</span>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="md:col-span-3 flex flex-col justify-between">
                  <div className="bg-gray-50 rounded-lg p-3 mb-3">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-gray-600">Á∑èÂêà„Çπ„Ç≥„Ç¢</span>
                      <span className="text-2xl font-bold text-primary-600">{factory.score}</span>
                    </div>
                    <div className="text-xs space-y-1 text-gray-500">
                      <div className="flex justify-between">
                        <span>‰æ°Ê†º</span>
                        <div className="w-20 bg-gray-200 rounded-full h-1.5 ml-2 mt-1">
                          <div className="bg-primary-500 h-1.5 rounded-full" style={{ width: `${scoreBreakdown.price}%` }} />
                        </div>
                      </div>
                      <div className="flex justify-between">
                        <span>Á¥çÊúü</span>
                        <div className="w-20 bg-gray-200 rounded-full h-1.5 ml-2 mt-1">
                          <div className="bg-primary-500 h-1.5 rounded-full" style={{ width: `${scoreBreakdown.speed}%` }} />
                        </div>
                      </div>
                    </div>
                  </div>
                  <Button variant={isSelected ? 'primary' : 'secondary'} onClick={() => setSelectedFactoryId(factory.id)}>
                    {isSelected ? (
                      <>
                        <CheckCircle className="w-4 h-4 mr-2" />ÈÅ∏Êäû‰∏≠
                      </>
                    ) : (
                      '„Åì„ÅÆÂ∑•Â†¥„ÇíÈÅ∏Êäû'
                    )}
                  </Button>
                </div>
              </div>
            </Card>
          )
        })}
      </div>

      {selectedFactoryId && (
        <Card className="bg-primary-50/50 border-2 border-primary-200">
          <div className="flex justify-between items-center">
            <div>
              <h3 className="text-lg font-semibold text-primary-900">{factories.find((f) => f.id === selectedFactoryId)?.name}„ÇíÈÅ∏Êäû‰∏≠</h3>
              <p className="text-primary-700 mt-1">ÂêàË®àÈáëÈ°ç: ¬•{(factories.find((f) => f.id === selectedFactoryId)!.price * product.quantity).toLocaleString()} ÔºàÁ®éËæº„ÉªÈÄÅÊñôÂà•Ôºâ</p>
            </div>
            <div className="flex gap-3">
              <Button variant="secondary" onClick={() => setSelectedFactoryId(null)}>ÈÅ∏Êäû„ÇíËß£Èô§</Button>
              <Button variant="primary" size="lg">Ê≥®Êñá„ÇíÁ¢∫ÂÆö„Åô„Çã</Button>
            </div>
          </div>
        </Card>
      )}

      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div className="flex">
          <AlertCircle className="w-5 h-5 text-blue-600 mr-2 flex-shrink-0 mt-0.5" />
          <div className="text-sm text-blue-800">
            <p className="font-semibold mb-1">Ë£ΩÈÄ†„Éë„Éº„Éà„Éä„ÉºÈÅ∏Êäû„ÅÆ„Éí„É≥„Éà</p>
            <ul className="list-disc list-inside space-y-1">
              <li>ÊÄ•„Åé„ÅÆÂ†¥Âêà„ÅØ„ÄåÁ¥çÊúüÈ†Ü„Äç„Åß„ÇΩ„Éº„Éà„Åó„Å¶ÊúÄÈÄü„ÅÆÂ∑•Â†¥„ÇíÈÅ∏Êäû</li>
              <li>‰∫àÁÆóÈáçË¶ñ„Å™„Çâ„Äå‰æ°Ê†ºÈ†Ü„Äç„ÅßÊúÄÂÆâÂÄ§„ÅÆÂ∑•Â†¥„Çí„ÉÅ„Çß„ÉÉ„ÇØ</li>
              <li>ÂìÅË≥™ÈáçË¶ñ„ÅÆÂ†¥Âêà„ÅØË©ï‰æ°4.5‰ª•‰∏ä„ÅÆÂ∑•Â†¥„ÇíÊé®Â•®</li>
              <li>ÂàùÂõûÊ≥®Êñá„ÅØÂ∞ëÈáèÂØæÂøúÂèØËÉΩ„Å™Â∑•Â†¥„Åß„ÉÜ„Çπ„Éà„Åô„Çã„Åì„Å®„Çí„Åä„Åô„Åô„ÇÅ</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  )
}

export default FactoryCompare
